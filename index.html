<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sales Report Template</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: 'Calibri', sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
      color: #333;
      font-size: 14px;
    }
    h2 {
      color: #666;
      margin-bottom: 12px;
      font-weight: bold;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px 6px;
      text-align: left;
    }
    th {
      background-color: #ddd;
    }
    input[type="file"] {
      margin-bottom: 8px;
    }
    button {
      padding: 6px 12px;
      font-size: 12px;
      background-color: #888;
      border: none;
      color: white;
      cursor: pointer;
      border-radius: 4px;
      margin-right: 8px;
    }
    button:hover {
      background-color: #555;
    }
    label {
      font-weight: bold;
      font-size: 12px;
    }
    #selectAllContainer {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      gap: 5px;
    }
    .checkbox-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }
    .column-check-label {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 6px;
      background-color: #fefefe;
      border: 1px solid #888;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .column-check-label input[type="checkbox"] {
      transform: scale(1.1);
    }
    .date-filter-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0;
    }
    .date-filter-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .date-filter-group input[type="date"] {
      font-size: 12px;
      padding: 4px;
      width: 120px;
    }
    #totalOrders {
      font-weight: bold;
      margin: 10px 0;
    }
    .export-buttons {
      display: flex;
      gap: 10px;
    }
  </style>
</head>
<body>

<h2>Sales Report Template</h2>

<input type="file" id="fileInput" accept=".xlsx,.xls,.csv,.pdf" />
<div id="selectAllContainer">
  <input type="checkbox" id="selectAll" checked>
  <label for="selectAll">Select/Unselect All</label>
</div>

<div class="checkbox-container" id="columnCheckboxes"></div>

<button onclick="processUploadedData()">Upload & Process</button>
<button onclick="resetAll()">Reset / Clear</button>

<div class="date-filter-container">
  <div class="date-filter-group">
    <label for="fromDate">From:</label>
    <input type="date" id="fromDate">
    <label for="toDate">To:</label>
    <input type="date" id="toDate">
    <button id="applyResetButton" onclick="renderTable()">Apply Filter</button>
    <button onclick="clearDateFilter()">Clear Filter</button>
  </div>

  <div class="export-buttons">
    <button onclick="exportToExcel()">Export to Excel</button>
    <button onclick="exportToCSV()">Export to CSV</button>
    <button onclick="exportToPDF()">Export to PDF</button>
  </div>
</div>

<div id="totalOrders"></div>

<table id="reportTable">
  <thead>
    <tr>
      <th>Order Date</th>
      <th>Ship From</th>
      <th>Order Number</th>
      <th>Item SKU</th>
      <th>Quantity</th>
      <th>Custom Field 1</th>
      <th>Custom Field 2</th>
      <th>Custom Field 3</th>
      <th>Order Total</th>
      <th>Recipient</th>
      <th>Rate</th>
      <th>Service</th>
      <th>Tracking Number</th>
      <th>PO Reference Number</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  let masterData = {};
  const headers = [
    "Order Date", "Ship From", "Order Number", "Item SKU", "Quantity",
    "Custom Field 1", "Custom Field 2", "Custom Field 3", "Order Total",
    "Recipient", "Rate", "Service", "Tracking Number", "PO Reference Number"
  ];
  const orderKeyAliases = ["Order Number", "Order #", "Site ID Number", "Site Order ID"];
  let currentOrderKey = null;

  document.getElementById("fileInput").addEventListener("change", handleFile);
  document.getElementById("selectAll").addEventListener("change", function () {
    const checkboxes = document.querySelectorAll('.column-check');
    checkboxes.forEach(cb => cb.checked = this.checked);
  });

  function handleFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    const ext = file.name.split('.').pop().toLowerCase();
    if (ext === "pdf") {
      readPDF(file);
    } else {
      readExcelCSV(file);
    }
  }

  function readExcelCSV(file) {
    const reader = new FileReader();
    reader.onload = function (e) {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: "array", cellDates: false });
      const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {
        defval: "",
        raw: false
      });
      setupColumnCheckboxes(Object.keys(sheet[0]), sheet);
    };
    reader.readAsArrayBuffer(file);
  }

  async function readPDF(file) {
    const reader = new FileReader();
    reader.onload = async function () {
      const pdfData = new Uint8Array(reader.result);
      const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
      let text = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(item => item.str).join('\t') + '\n';
      }
      const rows = text.split('\n').map(line => line.trim().split('\t').filter(cell => cell !== ''));
      const [headerRow, ...dataRows] = rows;
      const sheet = dataRows.map(row => {
        const obj = {};
        headerRow.forEach((h, i) => obj[h] = row[i] || "");
        return obj;
      });
      setupColumnCheckboxes(headerRow, sheet);
    };
    reader.readAsArrayBuffer(file);
  }

  function setupColumnCheckboxes(columns, sheetData) {
    window.tempSheetData = sheetData;
    currentOrderKey = orderKeyAliases.find(key => columns.includes(key));
    const container = document.getElementById("columnCheckboxes");
    container.innerHTML = "";
    headers.forEach(header => {
      const isAvailable = columns.includes(header);
      const wrapper = document.createElement("label");
      wrapper.className = "column-check-label";
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.className = "column-check";
      checkbox.value = header;
      checkbox.checked = isAvailable;
      checkbox.disabled = !isAvailable;
      wrapper.appendChild(checkbox);
      wrapper.append(header);
      container.appendChild(wrapper);
    });
  }

  function processUploadedData() {
    if (!currentOrderKey) {
      alert("No valid 'Order Number' column found.");
      return;
    }

    const selectedColumns = {};
    document.querySelectorAll(".column-check:checked").forEach(cb => {
      selectedColumns[cb.value] = cb.value;
    });

    window.tempSheetData.forEach(row => {
      const orderNum = row[currentOrderKey]?.toString().trim();
      if (!orderNum) return;

      if (!masterData[orderNum]) {
        masterData[orderNum] = {};
        headers.forEach(h => masterData[orderNum][h] = "");
        masterData[orderNum]["Order Number"] = orderNum;
      }

      for (let field in selectedColumns) {
        let incomingValue = row[field]?.toString().trim();

        if (field === "Item SKU" && !incomingValue) {
          incomingValue = row["SKU"]?.toString().trim() || "";
        }

        if (field === "Recipient" && !incomingValue) {
          const first = row["Shipping First Name"] || "";
          const last = row["Shipping Last Name"] || "";
          incomingValue = `${first} ${last}`.trim();
        }

        if (incomingValue && !masterData[orderNum][field]) {
          masterData[orderNum][field] = incomingValue;
        }
      }
    });

    renderTable();
  }

  function renderTable() {
    const tbody = document.querySelector("#reportTable tbody");
    const totalDisplay = document.getElementById("totalOrders");
    tbody.innerHTML = "";

    const from = document.getElementById("fromDate").value;
    const to = document.getElementById("toDate").value;

    let totalCount = 0;

    Object.values(masterData).forEach(row => {
      const orderDate = formatDate(row["Order Date"]);
      if ((from && orderDate < from) || (to && orderDate > to)) return;

      const tr = document.createElement("tr");
      headers.forEach(header => {
        const td = document.createElement("td");
        let content = header === "Order Date" ? orderDate : (row[header] || "");
        if (header === "Order Total") content = content.replace(/[^0-9.]/g, '');
        td.textContent = content;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
      totalCount++;
    });

    totalDisplay.textContent = `Total Orders: ${totalCount}`;
  }

  function formatDate(value) {
    if (!value) return "";
    const d = new Date(value);
    return !isNaN(d) ? d.toISOString().split("T")[0] : value;
  }

  function exportToExcel() {
    const rows = [headers];
    const from = document.getElementById("fromDate").value;
    const to = document.getElementById("toDate").value;
    Object.values(masterData).forEach(row => {
      const orderDate = formatDate(row["Order Date"]);
      if ((from && orderDate < from) || (to && orderDate > to)) return;
      rows.push(headers.map(h => {
        let val = row[h] || "";
        if (h === "Order Date") return orderDate;
        if (h === "Order Total") return val.replace(/[^0-9.]/g, '');
        return val;
      }));
    });
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, "Sales Report");
    XLSX.writeFile(wb, "Sales_Report.xlsx");
  }

  function exportToCSV() {
    const rows = [headers];
    const from = document.getElementById("fromDate").value;
    const to = document.getElementById("toDate").value;
    Object.values(masterData).forEach(row => {
      const orderDate = formatDate(row["Order Date"]);
      if ((from && orderDate < from) || (to && orderDate > to)) return;
      rows.push(headers.map(h => {
        let val = row[h] || "";
        if (h === "Order Date") return orderDate;
        if (h === "Order Total") return val.replace(/[^0-9.]/g, '');
        return val;
      }));
    });
    const csvContent = rows.map(e => e.map(v => `"${v}"`).join(",")).join("\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", "Sales_Report.csv");
    link.click();
  }

  function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const from = document.getElementById("fromDate").value;
    const to = document.getElementById("toDate").value;
    const data = Object.values(masterData)
      .filter(row => {
        const orderDate = formatDate(row["Order Date"]);
        return (!from || orderDate >= from) && (!to || orderDate <= to);
      })
      .map(row => headers.map(h => {
        if (h === "Order Date") return formatDate(row[h]);
        if (h === "Order Total") return (row[h] || "").replace(/[^0-9.]/g, '');
        return row[h] || "";
      }));
    doc.autoTable({
      head: [headers],
      body: data,
      startY: 10,
      styles: { fontSize: 8 },
      headStyles: { fillColor: [33, 150, 243] }
    });
    doc.save("Sales_Report.pdf");
  }

  function resetAll() {
    masterData = {};
    document.querySelector("#reportTable tbody").innerHTML = "";
    document.getElementById("columnCheckboxes").innerHTML = "";
    document.getElementById("selectAll").checked = true;
    document.getElementById("fileInput").value = "";
    document.getElementById("fromDate").value = "";
    document.getElementById("toDate").value = "";
    document.getElementById("totalOrders").textContent = "";
    currentOrderKey = null;
  }

  function clearDateFilter() {
    document.getElementById("fromDate").value = "";
    document.getElementById("toDate").value = "";
    renderTable();
  }
</script>

</body>
</html>
